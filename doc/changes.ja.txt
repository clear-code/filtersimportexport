# Thunderbird Message Filter Import/Export Enhanced 改造版 変更点

本アドオンは [Thunderbird Message Filter Import/Export Enhanced](https://addons.mozilla.org/ja/thunderbird/addon/tb-import-export-wind-li-port/)（GPL 2.0にて公開されている）を改造し、既知の問題の修正や新機能の追加を行った物です。

## 改造版での変更点

### 振り分け先の自動移行

別のアカウントからインポートしたメッセージフィルタについて、元のアカウント配下のフォルダにメールを振り分ける設定の物があった場合に、以下のいずれかの挙動を選択できます。

 * インポート先アカウント以下の同名フォルダに振り分けるようフィルタを変換してからインポートする。
 * 元の設定のままフィルタをインポートする。

### 振り分け先フォルダの自動作成

インポートしたメッセージフィルタの振り分け先に設定されているフォルダが存在しない場合に、以下のいずれかの挙動を選択できます。

 * 振り分け先のフォルダを自動的に作成する。
 * フィルタのインポートを中止する。

### インポート処理の説明

インポート操作を行うウィンドウの中に説明の文章を表示するようにしました。

### エクスポート先ファイル名の自動設定

エクスポート時のファイル名を、アカウント名と日付から自動的に求めるようにしました。

### いくつかのメッセージの日本語化

エラー時や処理完了時などのメッセージダイアログのタイトルおよび本文について、英語のままであった部分が何箇所かあったのを、日本語に翻訳しました。

### 最新のバージョンのThunderbirdに対応

いくつかの廃止されたAPIを試用していた箇所について、Thunderbird 24で動作するよう改修しました。

## 実装

### 振り分け先の自動移行

メッセージフィルタのいくつかのアクションについては、アクションの対象となるメールフォルダをThunderbirdの内部的な表現としてURLで表しています。
このURLは、通常のURLでのホスト名にあたる部分がアカウント名に、以降のパスがフォルダのパスに対応しています。

本アドオンの元のバージョンでは、インポートの際にアカウント名の部分を変換することを意図していると思われる処理が記述されていましたが、実際にはそのような処理を行っていませんでした。
そこで本アドオンにおいては、インポートの際に各フィルタのアクションの対象として指定されたURLのアカウント名部分について、インポート先アカウントの値に置換するようにしました。

### 振り分け先フォルダの自動作成

前述の通り、Thunderbirdのメッセージフィルタのアクションの対象となるフォルダはURLで示されています。そのため、URLを解析することで当該フォルダのフルパスを推測することができます。

IMAPメールアカウントのフォルダのURLについては、日本語などを含むフォルダ名はUTF-7を元にした「x-imap4-modified-utf7」というエンコーディング形式でエンコードされています。おり、元のフォルダ名と思われる文字列を復元できることが分かりました。本アドオンは、振り分け先フォルダのURLに対応するフォルダが存在しないことを検出した場合、URLから推測された情報に基づいてフォルダを自動的に作成します。これは以下の手順で行います。

 1. URLから対応するフォルダを探す。対応するフォルダが存在している場合、処理を終了する。
 2. URLをデリミタ（`/`）で分割して最後の部分を取り除き、「対象フォルダ自身の名前」と「親フォルダのURL」を求める。
 3. 親フォルダのURLについて、1から4の処理を再帰的に実施する。
 4. 親フォルダ内に対象フォルダの名前でサブフォルダを作成する作業を、タスクリストに追加する。
 5. 以上の処理の再帰的な繰り返しから、すべての不存在フォルダについて親→子の順で作成していくタスクリストができあがる。
 6. タスクリストの1件目を実行する。
 7. そのタスクが作成することになっていたフォルダが作成済みであるか確認する。
 8. フォルダがまだ存在しない場合、10秒間以上再実行を繰り返していたら、以降の処理をすべて中断してエラーを報告する。そうでなければ100ミリ秒後に再度7を実行する。
 9. フォルダの作成に成功したと判断し、タスクリストの1件目を削除する。
 10. タスクリストが空になるまでの間、6から9を繰り返す。
 11. タスクリストが空になった事を確認し、次の処理に進む。

### 挙動の選択の自動化

振り分け先の移行、並びに振り分け先フォルダの作成について、本アドオンは初期状態では実行の可否をユーザに尋ねます。以下の設定を行うことにより、実行の可否を決め打ちすることができます。

`"extensions.FiltersImportExport@mozilla.org.migrateAction"`

 * `1` で「振り分け先を常にインポート先アカウントに変更する」挙動になります。
 * `2` で「インポート処理を中断する」挙動になります。

`"extensions.FiltersImportExport@mozilla.org.missingDestinationAction"`

 * `1` で「フォルダを作成してインポートする」挙動になります。
 * `2` で「インポート処理を中断する」挙動になります。

### エクスポート時の既定のファイル名

エクスポート時の既定のファイル名は、以下の設定により変更できます。

`"extensions.FiltersImportExport@mozilla.org.export.defaultFileName"`

この時、値には以下のプレースホルダが1つ以上利用可能です。

 * %account（アカウント名）
 * %YYYY（4桁の年数） 2014 など。
 * %MM（2桁の月数） 01 など。
 * %DD （2桁の日数）。01 など。

それ以外の文字を書いた場合は、そのまま出力されます。

## 制限事項

 * IMAPアカウントで作成したメールフィルタのPOP3アカウントやローカルフォルダアカウントへの以降、あるいはその逆については、動作は保証されません。
 * 自動作成するフォルダの最大数、フォルダのパスの最大深さについては、本アドオンでは制限を設けていません。これらはThunderbird側の制限、またはWindows実行環境側での制限に依存します。
